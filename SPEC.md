# DECIDER Specification

This document defines the stable CLI contract, file formats, and behavior guarantees for DECIDER.

## ADR Format

### File Location

ADRs are stored in `docs/adr/` by default (configurable via `--dir`).

### Filename Convention

```
NNNN-kebab-case-title.md
```

- `NNNN`: Zero-padded 4-digit number (0001, 0002, ..., 9999)
- `kebab-case-title`: Lowercase with hyphens, derived from title
- Extension: `.md`

Example: `0042-use-postgresql-for-persistence.md`

### Frontmatter Schema

All ADRs must have YAML frontmatter between `---` delimiters:

```yaml
---
adr_id: ADR-NNNN        # Required. Format: ADR-NNNN (must match filename)
title: "Title"           # Required. Human-readable title
status: adopted         # Required. One of: proposed, adopted, rejected, deprecated, superseded
date: YYYY-MM-DD         # Required. ISO 8601 date
scope:
  paths:                 # Optional. Glob patterns for affected paths
    - "path/**"
tags:                    # Optional. Categorization tags
  - tag1
constraints:             # Optional. Rules that MUST be followed
  - "Constraint"
invariants:              # Optional. Properties that must always hold
  - "Invariant"
supersedes: []           # Optional. List of ADR IDs this supersedes
superseded_by: []        # Optional. List of ADR IDs that supersede this
related_adrs: []         # Optional. List of related ADR IDs
---
```

### Status Values

| Status | Description |
|--------|-------------|
| `proposed` | Under discussion, not yet decided |
| `adopted` | Approved and in effect |
| `rejected` | Considered and explicitly rejected |
| `deprecated` | Was adopted, now discouraged |
| `superseded` | Replaced by another ADR |

### Required Sections

ADR body MUST contain these markdown sections (## headings):

1. **Context** - Why this decision is needed
2. **Decision** - What was decided and why
3. **Alternatives Considered** - Other options evaluated
4. **Consequences** - Positive and negative impacts

Optional section:
- **Agent Guidance** - Instructions for AI agents

### Rationale Pattern

ADRs generated by DECIDER MUST include explicit rationale documentation using the following pattern:

#### Adopted Option

The chosen option MUST include:

```markdown
### [Option Name]: Adopted

**Adopted because:**
- Concrete reason tied to decision drivers
- Technical, operational, or strategic justification

**Adopted despite:**
- Known downside consciously accepted
- Trade-off compared to alternatives
```

#### Rejected Alternatives

Each rejected option MUST include:

```markdown
### [Option Name]: Rejected

**Rejected because:**
- Concrete reason for rejection
- How it failed to meet decision drivers

**Rejected despite:**
- Legitimate strength of this option
- Benefit that made it attractive
```

#### Prohibited Patterns

The following patterns MUST NOT be used as the sole decision documentation:

- Pros/cons tables without explicit rationale sections
- Freeform narrative without structured rationale headings
- Vague language like "better fit" without concrete justification
- Omitting "despite" sections (trade-offs MUST be documented)

## Index Format

### File Location

`docs/adr/index.yaml` (relative to ADR directory)

### Schema

```yaml
# AUTO-GENERATED by decider index - DO NOT EDIT
generated_at: "2026-01-16T10:30:00Z"   # RFC3339 UTC timestamp
adr_count: 4                            # Number of indexed ADRs
adrs:
  - adr_id: ADR-0001                    # ADR identifier
    title: "Decision Title"             # ADR title
    status: adopted                    # Current status
    date: "2026-01-16"                  # Decision date
    tags:                               # Tags (may be empty)
      - foundation
    scope_paths:                        # Scope paths (may be empty)
      - "src/**"
    file: "0001-decision-title.md"      # Filename
```

### Stability Guarantees

The following index keys are **stable** and will not change without a major version bump:
- `generated_at`
- `adr_count`
- `adrs`
- `adrs[].adr_id`
- `adrs[].title`
- `adrs[].status`
- `adrs[].date`
- `adrs[].tags`
- `adrs[].scope_paths`
- `adrs[].file`

New keys may be added in minor versions.

## CLI Commands

### decider init

Initialize ADR directory structure.

```
decider init [--dir PATH]
```

**Flags:**
- `--dir PATH` - ADR directory (default: `docs/adr`)

**Behavior:**
- Creates directory structure if missing
- Creates template file if missing
- Creates empty index.yaml if missing
- Idempotent (safe to run repeatedly)

**Exit codes:**
- 0: Success
- 1: Error

### decider new

Create a new ADR.

```
decider new [OPTIONS] TITLE
```

**Flags:**
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--tags CSV` - Comma-separated tags
- `--paths CSV` - Comma-separated scope paths (globs)
- `--status STATUS` - Initial status (default: `proposed`)
- `--no-index` - Skip updating index
- `--format FORMAT` - Output format: `text` | `json` (default: `text`)

**Behavior:**
- Determines next ADR number from existing files
- Generates kebab-case filename
- Creates ADR with template content
- Updates index (unless `--no-index`)

**Exit codes:**
- 0: Success
- 1: Error

### decider index

Generate or check the ADR index.

```
decider index [OPTIONS]
```

**Flags:**
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--check` - Verify index is up-to-date (don't modify)
- `--format FORMAT` - Output format: `text` | `json` | `yaml` (default: `text`)

**Behavior:**
- Without `--check`: Regenerates index.yaml
- With `--check`: Verifies index matches current ADRs

**Exit codes:**
- 0: Success (or index up-to-date with `--check`)
- 1: Error
- 2: Index out of date (with `--check`)

### decider list

List ADRs with optional filters.

```
decider list [OPTIONS]
```

**Flags:**
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--status STATUS` - Filter by status
- `--tag TAG` - Filter by tag (repeatable)
- `--path PATH` - Filter by scope path match
- `--format FORMAT` - Output format: `text` | `json` (default: `text`)

**Behavior:**
- Uses index.yaml if available, else scans ADR files
- Filters are AND-ed together

**Exit codes:**
- 0: Success
- 1: Error

### decider show

Display details of an ADR.

```
decider show [OPTIONS] IDENTIFIER
```

**Arguments:**
- `IDENTIFIER` - ADR-NNNN, NNNN, or filename

**Flags:**
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--format FORMAT` - Output format: `text` | `json` (default: `text`)

**Exit codes:**
- 0: Success
- 1: Error or ADR not found

### decider check adr

Validate ADRs for format compliance.

```
decider check adr [OPTIONS]
```

**Flags:**
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--strict` - Treat warnings as errors (exit code 2 on rationale pattern violations)
- `--format FORMAT` - Output format: `text` | `json` (default: `text`)

**Validates:**
- Required frontmatter keys present
- Status is valid enum value
- Date is YYYY-MM-DD format
- ADR ID matches pattern ADR-NNNN
- Filename number matches ADR ID
- Required sections present in body
- Rationale pattern presence (see below)

**Rationale Pattern Validation:**

DECIDER MUST detect missing rationale patterns during validation:
- Missing "Adopted because:" section
- Missing "Adopted despite:" section
- Missing "Rejected because:" for alternatives
- Missing "Rejected despite:" for alternatives

Enforcement policy:
- Default mode: Issues warnings for missing rationale pattern (exit code 0)
- Strict mode (`--strict`): Treats rationale violations as errors (exit code 2)

**Exit codes:**
- 0: All ADRs valid (warnings may be present in default mode)
- 1: Parse/usage error
- 2: Validation failures (errors, or warnings in strict mode)

### decider check diff

Find ADRs applicable to changed files.

```
decider check diff --base REF [OPTIONS]
```

**Flags:**
- `--base REF` - Base git ref for diff (required)
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--format FORMAT` - Output format: `text` | `json` (default: `text`)

**Behavior:**
- Gets changed files via `git diff --name-only BASE`
- Matches changed files against ADR scope.paths using glob matching
- Outputs applicable ADRs with their constraints/invariants

**Exit codes:**
- 0: Success
- 1: Parse/usage error

**Note:** Constraints are reported but not semantically enforced. The tool surfaces applicable ADRs; enforcement is the responsibility of the developer or CI pipeline.

### decider explain

Explain why ADRs apply to changes.

```
decider explain --base REF [OPTIONS]
```

**Flags:**
- `--base REF` - Base git ref for diff (required)
- `--dir PATH` - ADR directory (default: `docs/adr`)
- `--format FORMAT` - Output format: `text` | `json` (default: `text`)

**Behavior:**
- Like `check diff` but with narrative explanation
- Shows which patterns matched which files

**Exit codes:**
- 0: Success
- 1: Parse/usage error

### decider version

Show version information.

```
decider version
```

**Output:**
```
decider version X.Y.Z
  commit: <commit-sha>
  built:  <build-timestamp>
```

## Glob Pattern Matching

Scope paths use glob patterns:

| Pattern | Matches |
|---------|---------|
| `*.go` | Go files in current directory |
| `src/*` | Direct children of src/ |
| `src/**` | All files under src/ recursively |
| `src/**/*.go` | All Go files under src/ |
| `**/*.proto` | All .proto files anywhere |

## Non-Goals

The following are explicitly out of scope for DECIDER:

- **Semantic constraint enforcement**: Constraints are reported but not automatically enforced
- **ADR workflow enforcement**: No built-in approval process
- **Integration with issue trackers**: No JIRA/GitHub Issues linking
- **ADR templates customization**: Single default template only
- **Remote ADR repositories**: Local files only
